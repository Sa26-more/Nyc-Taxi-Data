{
	"name": "14_discovery_assignment",
	"properties": {
		"folder": {
			"name": "nyc_taxi/discovery"
		},
		"content": {
			"query": "USE nyc_taxi_discovery;\n\n--Identify the percentage of cash and credit card trips by borough\n\n--borough   |   total_trips |   cash_trips  |   card_trips  |   cash_trips_percentage   |   card_trips_percentage\n\n--get total_trips, cash_trips, card_trips, cash_trips_percentage, card_trips_percentage\n--FINAL FORMATTED ANSWER\nWITH CTE AS (\n  SELECT\n    PULocationID,\n    count(payment_type_desc) as total_trips,\n    SUM(\n      CASE\n        WHEN TRIM(payment_type_desc) = 'Cash' THEN 1\n        ELSE 0\n      END\n    ) as cash_trips,\n    SUM(\n      CASE\n        WHEN TRIM(payment_type_desc) = 'Credit card' THEN 1\n        ELSE 0\n      END\n    ) as card_trips,\n    CONVERT(\n      DECIMAL(10, 2),\n      ROUND(\n        (\n          SUM(\n            CASE\n              WHEN TRIM(payment_type_desc) = 'Cash' THEN 1\n              ELSE 0\n            END\n          )\n        ) * 100.0 / count(payment_type_desc),\n        2\n      )\n    ) as cash_trips_percentage,\n    CONVERT(\n      DECIMAL(10, 2),\n      ROUND(\n        (\n          SUM(\n            CASE\n              WHEN TRIM(payment_type_desc) = 'Credit card' THEN 1\n              ELSE 0\n            END\n          )\n        ) * 100.0 / count(payment_type_desc),\n        2\n      )\n    ) as card_trips_percentage\n  FROM\n    OPENROWSET(\n      BULK 'trip_data_green_parquet/**',\n      DATA_SOURCE = 'nyc_taxi_data_raw',\n      FORMAT = 'PARQUET'\n    ) WITH (\n      PULocationID INT 6,\n      payment_type1 INT 18\n    ) AS trip_data\n    JOIN OPENROWSET(\n      BULK 'payment_type.json',\n      DATA_SOURCE = 'nyc_taxi_data_raw',\n      FORMAT = 'CSV',\n      FIELDTERMINATOR = '0x0b',\n      FIELDQUOTE = '0x0b'\n    ) WITH (JsonData NVARCHAR(MAX)) AS payment_table\n    CROSS APPLY OPENJSON (payment_table.JsonData) WITH (\n      payment_type TINYINT,\n      payment_type_desc VARCHAR(20)\n    ) AS json_data ON json_data.payment_type = trip_data.payment_type1\n  GROUP BY\n    PULocationID\n)\nSELECT\n  borough_table.borough,\n  CTE.total_trips,\n  CTE.cash_trips,\n  CTE.card_trips,\n  CTE.cash_trips_percentage,\n  CTE.card_trips_percentage\nFROM\n  CTE\n  JOIN OPENROWSET(\n    BULK 'https://practicestorageravi.dfs.core.windows.net/nyc-taxi-data/raw/taxi_zone.csv',\n    FORMAT = 'CSV',\n    PARSER_VERSION = '2.0',\n    FIRSTROW = 2\n  ) WITH (\n    location_id SMALLINT 1,\n    borough VARCHAR(15) 2\n  ) AS borough_table ON CTE.PULocationID = borough_table.location_id;\n\nSELECT CONVERT(DECIMAL(10, 2), 23.0234) AS truncated_value;\n\n--First do join then apply calculation-------------------------------------------------------\nWITH CTE1 AS(\n  SELECT\n    PULocationID,\n    payment_type_desc\n  FROM\n    OPENROWSET(\n      BULK 'trip_data_green_parquet/**',\n      DATA_SOURCE = 'nyc_taxi_data_raw',\n      FORMAT = 'PARQUET'\n    ) WITH (\n      PULocationID INT 6,\n      payment_type1 INT 18\n    ) AS trip_data\n    JOIN OPENROWSET(\n      BULK 'payment_type.json',\n      DATA_SOURCE = 'nyc_taxi_data_raw',\n      FORMAT = 'CSV',\n      FIELDTERMINATOR = '0x0b',\n      FIELDQUOTE = '0x0b'\n    ) WITH (JsonData NVARCHAR(MAX)) AS payment_table\n    CROSS APPLY OPENJSON (payment_table.JsonData) WITH (\n      payment_type TINYINT,\n      payment_type_desc VARCHAR(20)\n    ) AS json_data ON json_data.payment_type = trip_data.payment_type1\n),\nCTE2 AS (\n  SELECT\n    payment_type_desc,\n    borough\n  FROM\n    CTE1\n    JOIN OPENROWSET(\n      BULK 'https://practicestorageravi.dfs.core.windows.net/nyc-taxi-data/raw/taxi_zone.csv',\n      FORMAT = 'CSV',\n      PARSER_VERSION = '2.0',\n      FIRSTROW = 2\n    ) WITH (\n      location_id SMALLINT 1,\n      borough VARCHAR(15) 2\n    ) AS borough_table ON CTE1.PULocationID = borough_table.location_id\n)\nSELECT\n  borough,\n  count(payment_type_desc) as total_trips,\n  SUM(\n    CASE\n      WHEN TRIM(payment_type_desc) = 'Cash' THEN 1\n      ELSE 0\n    END\n  ) as cash_trips,\n  SUM(\n    CASE\n      WHEN TRIM(payment_type_desc) = 'Credit card' THEN 1\n      ELSE 0\n    END\n  ) as card_trips,\n  CONVERT(\n    DECIMAL(10, 2),\n    ROUND(\n      (\n        SUM(\n          CASE\n            WHEN TRIM(payment_type_desc) = 'Cash' THEN 1\n            ELSE 0\n          END\n        )\n      ) * 100.0 / count(payment_type_desc),\n      2\n    )\n  ) as cash_trips_percentage,\n  CONVERT(\n    DECIMAL(10, 2),\n    ROUND(\n      (\n        SUM(\n          CASE\n            WHEN TRIM(payment_type_desc) = 'Credit card' THEN 1\n            ELSE 0\n          END\n        )\n      ) * 100.0 / count(payment_type_desc),\n      2\n    )\n  ) as card_trips_percentage\nFROM\n  CTE2\nGROUP BY\n  borough\nORDER BY\n  borough;\n\n\n\n--Borough column\nSELECT\n    *\nFROM\nOPENROWSET(\n    BULK 'https://practicestorageravi.dfs.core.windows.net/nyc-taxi-data/raw/taxi_zone.csv',\n    FORMAT = 'CSV',\n    PARSER_VERSION = '2.0',\n    FIRSTROW = 2\n    ) WITH (\n        location_id SMALLINT 1, \n        borough VARCHAR(15) 2\n    ) AS borough_table\n\n--payment_type\nselect\n    payment_type,\n    payment_type_desc\nfrom openrowset(\n        bulk 'payment_type.json',\n        data_source = 'nyc_taxi_data_raw',\n        format = 'csv',\n        fieldterminator ='0x0b',\n        fieldquote = '0x0b'\n    ) with (JsonData nvarchar(max)) as payment_type\n    cross apply openjson (JsonData)\n        with (  payment_type tinyint,\n                payment_type_desc varchar(20));",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "nyc_taxi_discovery",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}